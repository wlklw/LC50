<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>專業 LC50 計算工具 - 改進版</title>
    <style>
        /* CSS 樣式 - 美編與排版 */
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 20px auto;
            background-color: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        h2 {
            text-align: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 2.5em;
            margin-bottom: 20px;
        }

        .input-group, .results-group, .chart-container {
            background-color: #fff;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 25px;
        }

        label {
            font-weight: bold;
            display: block;
            margin-bottom: 8px;
            color: #4a4a4a;
        }

        input[type="number"], input[type="text"], select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus, select:focus {
            border-color: #667eea;
            outline: none;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .data-table th, .data-table td {
            border: 1px solid #e0e0e0;
            padding: 12px;
            text-align: center;
        }

        .data-table th {
            background-color: #f5f5f5;
            color: #666;
            font-weight: bold;
        }
        
        .data-table tbody tr:hover {
            background-color: #fafafa;
        }

        .button-group {
            text-align: center;
            margin-top: 20px;
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .button {
            padding: 15px 30px;
            font-size: 18px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            text-transform: uppercase;
            font-weight: bold;
        }

        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .calculate-btn {
            background-color: #667eea;
            color: white;
        }

        .add-row-btn {
            background-color: #11998e;
            color: white;
            font-size: 14px;
            padding: 10px 20px;
        }
        
        .export-btn {
            background-color: #29b6f6;
            color: white;
        }
        
        .reset-btn {
            background-color: #ff6b6b;
            color: white;
        }
        
        .results-section {
            display: none;
            text-align: center;
        }
        
        .results-section h3 {
            color: #667eea;
        }
        
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .result-box {
            background-color: #f8faff;
            border: 1px solid #e5e9ff;
            padding: 20px;
            border-radius: 10px;
            text-align: left;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.03);
        }

        .result-box h4 {
            color: #4a4a4a;
            margin-top: 0;
            margin-bottom: 10px;
        }

        .result-box p {
            margin: 0;
            font-size: 1.1em;
            color: #333;
        }

        .result-box span {
            font-weight: bold;
            color: #667eea;
        }
        
        .chart-container {
            position: relative;
            height: 400px;
        }
        
        .error-message {
            background-color: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            text-align: left;
            display: none; /* 初始隱藏 */
        }
        
        .error-message.active {
            display: block;
        }
        
        .keyboard-focused {
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.5);
            border-color: #667eea;
        }
        
        #validation-info {
            background-color: #f0f4ff;
            border: 1px dashed #667eea;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            text-align: left;
            color: #333;
            font-size: 0.9em;
        }
        
        .footer {
            text-align: center;
            font-size: 0.8em;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 40px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>LC50/LC75/LC90 專業計算工具</h2>

        <div class="input-group">
            <h3>輸入數據</h3>
            
            <label for="unit-select">選擇濃度單位:</label>
            <div class="unit-group">
                <select id="unit-select">
                    <option value="mg/L">mg/L</option>
                    <option value="mg/kg">mg/kg</option>
                    <option value="custom">自訂</option>
                </select>
                <input type="text" id="custom-unit-input" placeholder="請輸入單位名稱" style="display:none; margin-top: 5px;">
            </div>

            <div class="input-group">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h4 id="group1-title">第一組數據 (實驗組A)</h4>
                    <input type="text" id="group1-name" value="實驗組 A" style="width: 150px; text-align: right;">
                </div>
                <table id="data-table-1" class="data-table">
                    <thead>
                        <tr>
                            <th>濃度</th>
                            <th>總數</th>
                            <th>死亡數</th>
                            <th>死亡率(%)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><input type="number" class="concentration" step="any"></td>
                            <td><input type="number" class="total" min="1"></td>
                            <td><input type="number" class="dead" min="0"></td>
                            <td><span class="mortality-display">--</span></td>
                        </tr>
                    </tbody>
                </table>
                <div style="text-align: right; margin-top: 10px;">
                    <button id="add-row-btn-1" class="button add-row-btn">新增一行</button>
                </div>
            </div>

            <div class="input-group">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h4 id="group2-title">第二組數據 (實驗組B) - 可選</h4>
                    <input type="text" id="group2-name" value="實驗組 B" style="width: 150px; text-align: right;">
                </div>
                <table id="data-table-2" class="data-table">
                    <thead>
                        <tr>
                            <th>濃度</th>
                            <th>總數</th>
                            <th>死亡數</th>
                            <th>死亡率(%)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><input type="number" class="concentration" step="any"></td>
                            <td><input type="number" class="total" min="1"></td>
                            <td><input type="number" class="dead" min="0"></td>
                            <td><span class="mortality-display">--</span></td>
                        </tr>
                    </tbody>
                </table>
                <div style="text-align: right; margin-top: 10px;">
                    <button id="add-row-btn-2" class="button add-row-btn">新增一行</button>
                </div>
            </div>

            <div class="input-group">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h4 id="group3-title">第三組數據 (實驗組C) - 可選</h4>
                    <input type="text" id="group3-name" value="實驗組 C" style="width: 150px; text-align: right;">
                </div>
                <table id="data-table-3" class="data-table">
                    <thead>
                        <tr>
                            <th>濃度</th>
                            <th>總數</th>
                            <th>死亡數</th>
                            <th>死亡率(%)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><input type="number" class="concentration" step="any"></td>
                            <td><input type="number" class="total" min="1"></td>
                            <td><input type="number" class="dead" min="0"></td>
                            <td><span class="mortality-display">--</span></td>
                        </tr>
                    </tbody>
                </table>
                <div style="text-align: right; margin-top: 10px;">
                    <button id="add-row-btn-3" class="button add-row-btn">新增一行</button>
                </div>
            </div>

            <div class="button-group">
                <button id="calculate-btn" class="button calculate-btn">開始計算</button>
                <button id="reset-btn" class="button reset-btn">重設</button>
            </div>
        </div>

        <div id="results-section" class="results-section">
            <h3>計算結果</h3>
            
            <div id="validation-info">
                <h4>數據驗證</h4>
                <div id="validation-details"></div>
            </div>

            <div class="results-grid">
                <div id="results-group-1" class="results-group">
                    <h4 id="results-title-1">第一組數據 (實驗組A)</h4>
                    <div class="result-box">
                        <p>LC50: <span id="lc50-result-1">--</span></p>
                        <p id="lc50-ci-1" style="font-size: 0.9em;"></p>
                    </div>
                    <div class="result-box">
                        <p>LC75: <span id="lc75-result-1">--</span></p>
                    </div>
                    <div class="result-box">
                        <p>LC90: <span id="lc90-result-1">--</span></p>
                    </div>
                    <div class="result-box">
                        <p>回歸線斜率: <span id="slope-result-1">--</span></p>
                    </div>
                </div>

                <div id="results-group-2" class="results-group" style="display: none;">
                    <h4 id="results-title-2">第二組數據 (實驗組B)</h4>
                    <div class="result-box">
                        <p>LC50: <span id="lc50-result-2">--</span></p>
                        <p id="lc50-ci-2" style="font-size: 0.9em;"></p>
                    </div>
                    <div class="result-box">
                        <p>LC75: <span id="lc75-result-2">--</span></p>
                    </div>
                    <div class="result-box">
                        <p>LC90: <span id="lc90-result-2">--</span></p>
                    </div>
                    <div class="result-box">
                        <p>回歸線斜率: <span id="slope-result-2">--</span></p>
                    </div>
                </div>

                <div id="results-group-3" class="results-group" style="display: none;">
                    <h4 id="results-title-3">第三組數據 (實驗組C)</h4>
                    <div class="result-box">
                        <p>LC50: <span id="lc50-result-3">--</span></p>
                        <p id="lc50-ci-3" style="font-size: 0.9em;"></p>
                    </div>
                    <div class="result-box">
                        <p>LC75: <span id="lc75-result-3">--</span></p>
                    </div>
                    <div class="result-box">
                        <p>LC90: <span id="lc90-result-3">--</span></p>
                    </div>
                    <div class="result-box">
                        <p>回歸線斜率: <span id="slope-result-3">--</span></p>
                    </div>
                </div>
            </div>

            <div class="chart-container">
                <canvas id="probit-chart"></canvas>
            </div>
            
            <div class="button-group">
                <button id="export-pdf-btn" class="button export-btn">匯出為 PDF</button>
            </div>
        </div>

    </div>

    <div class="footer">
        © 2025 專業 LC50 分析工具. All rights reserved.
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    
    <script src="js/fonts/NotoSansTC-normal.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // 宣告所有變數，確保元素已載入
            const unitSelect = document.getElementById('unit-select');
            const customUnitInput = document.getElementById('custom-unit-input');
            const dataTable1 = document.getElementById('data-table-1');
            const dataTable2 = document.getElementById('data-table-2');
            const dataTable3 = document.getElementById('data-table-3');
            const addRowBtn1 = document.getElementById('add-row-btn-1');
            const addRowBtn2 = document.getElementById('add-row-btn-2');
            const addRowBtn3 = document.getElementById('add-row-btn-3');
            const calculateBtn = document.getElementById('calculate-btn');
            const exportPdfBtn = document.getElementById('export-pdf-btn');
            const resetBtn = document.getElementById('reset-btn');
            const resultsSection = document.getElementById('results-section');
            const resultsGroup1 = document.getElementById('results-group-1');
            const resultsGroup2 = document.getElementById('results-group-2');
            const resultsGroup3 = document.getElementById('results-group-3');
            const validationInfo = document.getElementById('validation-info');
            const validationDetails = document.getElementById('validation-details');
            const group1NameInput = document.getElementById('group1-name');
            const group2NameInput = document.getElementById('group2-name');
            const group3NameInput = document.getElementById('group3-name');
            
            let probitChart;

            // 更新組名顯示
            function updateGroupNames() {
                if (group1NameInput) document.getElementById('group1-title').textContent = `第一組數據 (${group1NameInput.value})`;
                if (group2NameInput) document.getElementById('group2-title').textContent = `第二組數據 (${group2NameInput.value}) - 可選`;
                if (group3NameInput) document.getElementById('group3-title').textContent = `第三組數據 (${group3NameInput.value}) - 可選`;
                
                if (group1NameInput) document.getElementById('results-title-1').textContent = `第一組數據 (${group1NameInput.value})`;
                if (group2NameInput) document.getElementById('results-title-2').textContent = `第二組數據 (${group2NameInput.value})`;
                if (group3NameInput) document.getElementById('results-title-3').textContent = `第三組數據 (${group3NameInput.value})`;
            }
            
            // 監聽組名變更 (加上防呆機制)
            if (group1NameInput) group1NameInput.addEventListener('input', updateGroupNames);
            if (group2NameInput) group2NameInput.addEventListener('input', updateGroupNames);
            if (group3NameInput) group3NameInput.addEventListener('input', updateGroupNames);
            
            // 初始化組名
            updateGroupNames();

            // 處理自訂單位輸入框的顯示
            unitSelect.addEventListener('change', () => {
                if (unitSelect.value === 'custom') {
                    customUnitInput.style.display = 'inline-block';
                } else {
                    customUnitInput.style.display = 'none';
                }
            });

            // 鍵盤導航功能
            function setupKeyboardNavigation() {
                const allInputs = document.querySelectorAll('.data-table input[type="number"]');
                
                allInputs.forEach((input, index) => {
                    input.addEventListener('keydown', (e) => {
                        let nextIndex = -1;
                        
                        switch(e.key) {
                            case 'ArrowDown':
                                e.preventDefault();
                                nextIndex = findNextRowInput(input, 1);
                                break;
                            case 'ArrowUp':
                                e.preventDefault();
                                nextIndex = findNextRowInput(input, -1);
                                break;
                            case 'ArrowRight':
                            case 'Tab':
                                if (e.key === 'Tab' && e.shiftKey) break;
                                e.preventDefault();
                                nextIndex = findNextColumnInput(input, 1);
                                break;
                            case 'ArrowLeft':
                                e.preventDefault();
                                nextIndex = findNextColumnInput(input, -1);
                                break;
                            case 'Enter':
                                e.preventDefault();
                                nextIndex = findNextRowInput(input, 1);
                                break;
                        }
                        
                        if (nextIndex !== -1) {
                            const nextInput = document.querySelectorAll('.data-table input[type="number"]')[nextIndex];
                            if (nextInput) {
                                nextInput.focus();
                                nextInput.select();
                            }
                        }
                    });
                    
                    // 視覺反饋
                    input.addEventListener('focus', () => {
                        input.classList.add('keyboard-focused');
                    });
                    
                    input.addEventListener('blur', () => {
                        input.classList.remove('keyboard-focused');
                    });
                });
            }
            
            function findNextRowInput(currentInput, direction) {
                const allInputs = Array.from(document.querySelectorAll('.data-table input[type="number"]'));
                const currentIndex = allInputs.indexOf(currentInput);
                const currentRow = currentInput.closest('tr');
                const currentTable = currentInput.closest('table');
                const currentColumn = Array.from(currentRow.querySelectorAll('input[type="number"]')).indexOf(currentInput);
                
                let nextRow;
                if (direction > 0) {
                    nextRow = currentRow.nextElementSibling;
                    if (!nextRow) {
                        // 尋找下一個表格的第一行
                        let nextTable = currentTable.parentNode;
                        while (nextTable && nextTable.nextElementSibling) {
                            nextTable = nextTable.nextElementSibling;
                            const foundTable = nextTable.querySelector('.data-table');
                            if (foundTable) {
                                nextRow = foundTable.querySelector('tbody tr');
                                break;
                            }
                        }
                    }
                } else {
                    nextRow = currentRow.previousElementSibling;
                    if (!nextRow) {
                        // 尋找上一個表格的最後一行
                        let prevTable = currentTable.parentNode;
                        while (prevTable && prevTable.previousElementSibling) {
                            prevTable = prevTable.previousElementSibling;
                            const foundTable = prevTable.querySelector('.data-table');
                            if (foundTable) {
                                const rows = foundTable.querySelectorAll('tbody tr');
                                nextRow = rows[rows.length - 1];
                                break;
                            }
                        }
                    }
                }
                
                if (nextRow) {
                    const nextInput = nextRow.querySelectorAll('input[type="number"]')[currentColumn];
                    if (nextInput) {
                        const nextIndex = allInputs.indexOf(nextInput);
                        return nextIndex;
                    }
                }
                
                return -1;
            }
            
            function findNextColumnInput(currentInput, direction) {
                const allInputs = Array.from(document.querySelectorAll('.data-table input[type="number"]'));
                const currentIndex = allInputs.indexOf(currentInput);
                const currentRow = currentInput.closest('tr');
                const rowInputs = Array.from(currentRow.querySelectorAll('input[type="number"]'));
                const currentColumn = rowInputs.indexOf(currentInput);
                
                let nextInput;
                if (direction > 0) {
                    if (currentColumn < rowInputs.length - 1) {
                        nextInput = rowInputs[currentColumn + 1];
                    } else {
                        // 移到下一行的第一列
                        return findNextRowInput(currentInput, 1);
                    }
                } else {
                    if (currentColumn > 0) {
                        nextInput = rowInputs[currentColumn - 1];
                    } else {
                        // 移到上一行的最後一列
                        const prevRowIndex = findNextRowInput(currentInput, -1);
                        if (prevRowIndex !== -1) {
                            const prevInput = allInputs[prevRowIndex];
                            const prevRow = prevInput.closest('tr');
                            const prevRowInputs = Array.from(prevRow.querySelectorAll('input[type="number"]'));
                            nextInput = prevRowInputs[prevRowInputs.length - 1];
                        }
                    }
                }
                
                if (nextInput) {
                    return allInputs.indexOf(nextInput);
                }
                
                return -1;
            }

            // 新增數據列
            addRowBtn1.addEventListener('click', () => addRow(dataTable1.querySelector('tbody'), 1));
            addRowBtn2.addEventListener('click', () => addRow(dataTable2.querySelector('tbody'), 2));
            addRowBtn3.addEventListener('click', () => addRow(dataTable3.querySelector('tbody'), 3));

            function addRow(tableBody, groupNum) {
                const rowCount = tableBody.children.length;
                const baseTabIndex = groupNum * 100 + rowCount * 10;
                
                const newRow = tableBody.insertRow();
                newRow.innerHTML = `
                    <td><input type="number" class="concentration" step="any" tabindex="${baseTabIndex + 1}"></td>
                    <td><input type="number" class="total" min="1" tabindex="${baseTabIndex + 2}"></td>
                    <td><input type="number" class="dead" min="0" tabindex="${baseTabIndex + 3}"></td>
                    <td><span class="mortality-display">--</span></td>
                `;
                attachInputListeners(newRow);
                setupKeyboardNavigation();
            }

            // 附加輸入監聽器來自動計算死亡率
            function attachInputListeners(row) {
                const totalInput = row.querySelector('.total');
                const deadInput = row.querySelector('.dead');
                const mortalityDisplay = row.querySelector('.mortality-display');

                function updateMortality() {
                    const total = parseInt(totalInput.value);
                    const dead = parseInt(deadInput.value);
                    if (!isNaN(total) && !isNaN(dead) && total > 0) {
                        if (dead > total) {
                            deadInput.value = total;
                        }
                        const mortality = (parseInt(deadInput.value) / total * 100).toFixed(1);
                        mortalityDisplay.textContent = mortality + '%';
                    } else {
                        mortalityDisplay.textContent = '--';
                    }
                }

                totalInput.addEventListener('input', updateMortality);
                deadInput.addEventListener('input', updateMortality);
            }

            // 初始化現有行的監聽器和鍵盤導航
            document.querySelectorAll('.data-table tbody tr').forEach(attachInputListeners);
            setupKeyboardNavigation();

            // 處理 Excel 貼上功能
            document.querySelectorAll('.data-table').forEach(table => {
                table.addEventListener('paste', (event) => {
                    const tableBody = table.querySelector('tbody');
                    let pasteData = event.clipboardData.getData('text/plain');
                    let rows = pasteData.trim().split('\n');
                    
                    // 清空現有表格內容
                    tableBody.innerHTML = '';
                    
                    const tableId = table.id;
                    const groupNum = parseInt(tableId.split('-')[2]);
                    
                    rows.forEach((rowString, index) => {
                        const cols = rowString.trim().split(/[\t\s]+/);
                        if (cols.length >= 3) {
                            const baseTabIndex = groupNum * 100 + index * 10;
                            const newRow = tableBody.insertRow();
                            const concentration = parseFloat(cols[0]);
                            const total = parseInt(cols[1]);
                            const dead = parseInt(cols[2]);
                            const mortality = (!isNaN(total) && !isNaN(dead) && total > 0) ? 
                                (dead / total * 100).toFixed(1) : '--';
                            
                            newRow.innerHTML = `
                                <td><input type="number" class="concentration" step="any" value="${cols[0]}" tabindex="${baseTabIndex + 1}"></td>
                                <td><input type="number" class="total" min="1" value="${cols[1]}" tabindex="${baseTabIndex + 2}"></td>
                                <td><input type="number" class="dead" min="0" value="${cols[2]}" tabindex="${baseTabIndex + 3}"></td>
                                <td><span class="mortality-display">${mortality}%</span></td>
                            `;
                            attachInputListeners(newRow);
                        }
                    });
                    setupKeyboardNavigation();
                    event.preventDefault();
                });
            });

            // 重設按鈕功能
            resetBtn.addEventListener('click', () => {
                dataTable1.querySelector('tbody').innerHTML = `<tr><td><input type="number" class="concentration" step="any" tabindex="1"></td><td><input type="number" class="total" min="1" tabindex="2"></td><td><input type="number" class="dead" min="0" tabindex="3"></td><td><span class="mortality-display">--</span></td></tr>`;
                dataTable2.querySelector('tbody').innerHTML = `<tr><td><input type="number" class="concentration" step="any" tabindex="101"></td><td><input type="number" class="total" min="1" tabindex="102"></td><td><input type="number" class="dead" min="0" tabindex="103"></td><td><span class="mortality-display">--</span></td></tr>`;
                dataTable3.querySelector('tbody').innerHTML = `<tr><td><input type="number" class="concentration" step="any" tabindex="201"></td><td><input type="number" class="total" min="1" tabindex="202"></td><td><input type="number" class="dead" min="0" tabindex="203"></td><td><span class="mortality-display">--</span></td></tr>`;
                
                // 重新附加監聽器
                document.querySelectorAll('.data-table tbody tr').forEach(attachInputListeners);
                setupKeyboardNavigation();
                
                resultsSection.style.display = 'none';
                resultsGroup2.style.display = 'none';
                resultsGroup3.style.display = 'none';
                exportPdfBtn.style.display = 'none';
                if (probitChart) {
                    probitChart.destroy();
                }
            });

            // 主要計算功能
            calculateBtn.addEventListener('click', () => {
                try {
                    const data1 = getDataFromTable(dataTable1);
                    const data2 = getDataFromTable(dataTable2);
                    const data3 = getDataFromTable(dataTable3);
                    
                    if (data1.length < 3) {
                        showError('第一組數據請至少輸入三組有效數據以確保統計計算的可靠性。');
                        return;
                    }

                    // 驗證數據質量
                    const validation1 = validateData(data1);
                    if (!validation1.isValid) {
                        showError(`第一組數據驗證失敗：${validation1.message}`);
                        return;
                    }

                    const probitResults1 = calculateProbit(data1);
                    displayResults(probitResults1, 1);
                    
                    let datasets = createChartDatasets(data1, probitResults1, 1);
                    let validationText = `${group1NameInput.value}：${validation1.message}`;

                    if (data2.length >= 3) {
                        const validation2 = validateData(data2);
                        if (validation2.isValid) {
                            const probitResults2 = calculateProbit(data2);
                            displayResults(probitResults2, 2);
                            datasets = datasets.concat(createChartDatasets(data2, probitResults2, 2));
                            validationText += `<br>${group2NameInput.value}：${validation2.message}`;
                            resultsGroup2.style.display = 'block';
                        } else {
                            validationText += `<br>${group2NameInput.value}：驗證失敗 - ${validation2.message}`;
                        }
                    } else {
                        resultsGroup2.style.display = 'none';
                    }

                    if (data3.length >= 3) {
                        const validation3 = validateData(data3);
                        if (validation3.isValid) {
                            const probitResults3 = calculateProbit(data3);
                            displayResults(probitResults3, 3);
                            datasets = datasets.concat(createChartDatasets(data3, probitResults3, 3));
                            validationText += `<br>${group3NameInput.value}：${validation3.message}`;
                            resultsGroup3.style.display = 'block';
                        } else {
                            validationText += `<br>${group3NameInput.value}：驗證失敗 - ${validation3.message}`;
                        }
                    } else {
                        resultsGroup3.style.display = 'none';
                    }
                    
                    validationDetails.innerHTML = validationText;
                    resultsSection.style.display = 'block';
                    exportPdfBtn.style.display = 'inline-block';
                    renderChart(datasets);

                } catch (e) {
                    showError('計算失敗：' + e.message);
                }
            });

            function showError(message) {
                const oldError = document.querySelector('.error-message');
                if (oldError) oldError.remove();

                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-message active';
                errorDiv.innerHTML = `<strong>錯誤：</strong> ${message}`;
                calculateBtn.parentNode.insertBefore(errorDiv, calculateBtn.nextSibling);

                setTimeout(() => {
                    errorDiv.remove();
                }, 5000);
            }

            function getDataFromTable(table) {
                const rows = table.querySelectorAll('tbody tr');
                let data = [];
                
                rows.forEach((row, index) => {
                    const concentrationInput = row.querySelector('.concentration');
                    const totalInput = row.querySelector('.total');
                    const deadInput = row.querySelector('.dead');
                    
                    if (!concentrationInput || !totalInput || !deadInput) return;

                    const concentration = parseFloat(concentrationInput.value);
                    const total = parseInt(totalInput.value);
                    const dead = parseInt(deadInput.value);

                    if (!isNaN(concentration) && !isNaN(total) && !isNaN(dead) && 
                        concentration > 0 && total > 0 && dead >= 0 && dead <= total) {
                        
                        let mortality = dead / total;
                        let adjustedMortality = mortality;
                        
                        if (mortality === 0) {
                            adjustedMortality = 0.5 / total;
                        } else if (mortality === 1) {
                            adjustedMortality = (total - 0.5) / total;
                        }
                        
                        data.push({
                            concentration: concentration,
                            total: total,
                            dead: dead,
                            mortality: mortality,
                            adjustedMortality: adjustedMortality,
                            probit: probit(adjustedMortality)
                        });
                    }
                });
                
                data.sort((a, b) => a.concentration - b.concentration);
                return data;
            }

            function validateData(data) {
                if (data.length < 3) {
                    return { isValid: false, message: '數據點不足，需要至少3個有效數據點' };
                }

                const concentrations = data.map(d => d.concentration);
                const mortalities = data.map(d => d.mortality);
                
                const minConc = Math.min(...concentrations);
                const maxConc = Math.max(...concentrations);
                const minMort = Math.min(...mortalities);
                const maxMort = Math.max(...mortalities);

                if (maxConc / minConc < 2) {
                    return { isValid: false, message: '濃度範圍太小，建議最高濃度至少是最低濃度的2倍' };
                }

                if (maxMort - minMort < 0.3) {
                    return { isValid: false, message: '死亡率變化範圍太小，建議涵蓋至少30%的死亡率變化' };
                }

                let isMonotonic = true;
                for (let i = 1; i < data.length; i++) {
                    if (data[i].concentration > data[i-1].concentration && 
                        data[i].mortality < data[i-1].mortality) {
                        isMonotonic = false;
                        break;
                    }
                }

                if (!isMonotonic) {
                    return { 
                        isValid: true, 
                        message: '警告：數據未完全符合單調遞增關係，結果可能不夠準確' 
                    };
                }

                return { 
                    isValid: true, 
                    message: `數據驗證通過，共${data.length}個有效數據點，濃度範圍：${minConc.toFixed(2)}-${maxConc.toFixed(2)}，死亡率範圍：${(minMort*100).toFixed(1)}%-${(maxMort*100).toFixed(1)}%` 
                };
            }

            function probit(p) {
                if (p <= 0 || p >= 1) {
                    throw new Error(`無效的死亡率值: ${p}`);
                }
                
                const z = inverseNormalCDF(p);
                return 5 + z;
            }

            function inverseNormalCDF(p) {
                if (p < 0.5) {
                    return -inverseNormalCDF(1 - p);
                }
                
                const t = Math.sqrt(-2 * Math.log(1 - p));
                
                const c0 = 2.515517;
                const c1 = 0.802853;
                const c2 = 0.010328;
                const d1 = 1.432788;
                const d2 = 0.189269;
                const d3 = 0.001308;
                
                return t - ((c2*t + c1)*t + c0) / (((d3*t + d2)*t + d1)*t + 1);
            }

            function calculateProbit(data) {
                const n = data.length;
                
                let sumW = 0, sumWX = 0, sumWY = 0, sumWXY = 0, sumWX2 = 0;
                
                data.forEach(d => {
                    const logConc = Math.log10(d.concentration);
                    const weight = calculateWeight(d.adjustedMortality, d.total);
                    
                    sumW += weight;
                    sumWX += weight * logConc;
                    sumWY += weight * d.probit;
                    sumWXY += weight * logConc * d.probit;
                    sumWX2 += weight * logConc * logConc;
                });

                const denominator = sumW * sumWX2 - sumWX * sumWX;
                if (Math.abs(denominator) < 1e-10) {
                    throw new Error('回歸計算失敗：矩陣奇異');
                }
                
                const a = (sumWY * sumWX2 - sumWX * sumWXY) / denominator;
                const b = (sumW * sumWXY - sumWX * sumWY) / denominator;
                
                if (b <= 0) {
                    throw new Error('回歸線斜率為負或零，數據不符合劑量-反應關係');
                }

                const logLC50 = (5 - a) / b;
                const logLC75 = (5.67 - a) / b;
                const logLC90 = (6.28 - a) / b;

                const confidenceInterval = calculateConfidenceInterval(data, a, b, logLC50);
                const goodnessOfFit = calculateGoodnessOfFit(data, a, b);

                return {
                    lc50: Math.pow(10, logLC50),
                    lc75: Math.pow(10, logLC75),
                    lc90: Math.pow(10, logLC90),
                    ci50: confidenceInterval,
                    slope: b,
                    intercept: a,
                    r2: goodnessOfFit.r2,
                    chiSquare: goodnessOfFit.chiSquare,
                    pValue: goodnessOfFit.pValue
                };
            }

            function calculateWeight(p, n) {
                const z = inverseNormalCDF(p);
                const phi = (1 / Math.sqrt(2 * Math.PI)) * Math.exp(-0.5 * z * z);
                return (n * phi * phi) / (p * (1 - p));
            }

            function calculateConfidenceInterval(data, a, b, logLC50) {
                const n = data.length;
                const df = n - 2;
                
                let sumSquaredResiduals = 0;
                data.forEach(d => {
                    const logConc = Math.log10(d.concentration);
                    const predicted = a + b * logConc;
                    sumSquaredResiduals += Math.pow(d.probit - predicted, 2);
                });
                
                const mse = sumSquaredResiduals / df;
                const seSlope = Math.sqrt(mse / data.reduce((sum, d) => {
                    const logConc = Math.log10(d.concentration);
                    const meanLogConc = data.reduce((s, item) => s + Math.log10(item.concentration), 0) / n;
                    return sum + Math.pow(logConc - meanLogConc, 2);
                }, 0));
                
                const tValue = getTValue(df, 0.025);
                const seLogLC50 = seSlope / Math.abs(b);
                
                const margin = tValue * seLogLC50;
                return [
                    Math.pow(10, logLC50 - margin),
                    Math.pow(10, logLC50 + margin)
                ];
            }

            function getTValue(df, alpha) {
                const tTable = {
                    1: 12.706, 2: 4.303, 3: 3.182, 4: 2.776, 5: 2.571,
                    6: 2.447, 7: 2.365, 8: 2.306, 9: 2.262, 10: 2.228,
                    15: 2.131, 20: 2.086, 30: 2.042, 50: 2.009, 100: 1.984
                };
                
                if (tTable[df]) return tTable[df];
                if (df <= 30) return 2.042;
                return 1.96;
            }

            function calculateGoodnessOfFit(data, a, b) {
                const n = data.length;
                let ssTot = 0, ssRes = 0;
                const meanProbit = data.reduce((sum, d) => sum + d.probit, 0) / n;
                
                data.forEach(d => {
                    const logConc = Math.log10(d.concentration);
                    const predicted = a + b * logConc;
                    ssTot += Math.pow(d.probit - meanProbit, 2);
                    ssRes += Math.pow(d.probit - predicted, 2);
                });
                
                const r2 = 1 - (ssRes / ssTot);
                
                let chiSquare = 0;
                data.forEach(d => {
                    const logConc = Math.log10(d.concentration);
                    const predictedProbit = a + b * logConc;
                    const predictedP = normalCDF(predictedProbit - 5);
                    const expected = predictedP * d.total;
                    if (expected > 0) {
                        chiSquare += Math.pow(d.dead - expected, 2) / expected;
                    }
                });
                
                const df = n - 2;
                const pValue = 1 - chiSquareCDF(chiSquare, df);
                
                return { r2, chiSquare, pValue };
            }

            function normalCDF(x) {
                const a1 =  0.254829592;
                const a2 = -0.284496736;
                const a3 =  1.421413741;
                const a4 = -1.453152027;
                const a5 =  1.061405429;
                const p  =  0.3275911;
                
                const sign = x < 0 ? -1 : 1;
                x = Math.abs(x);
                
                const t = 1.0 / (1.0 + p * x);
                const y = 1.0 - (((((a5 * t + a4) * t) + a3) * t + a2) * t + a1) * t * Math.exp(-x * x);
                
                return sign * y;
            }

            function erf(x) {
                const a1 =  0.254829592;
                const a2 = -0.284496736;
                const a3 =  1.421413741;
                const a4 = -1.453152027;
                const a5 =  1.061405429;
                const p  =  0.3275911;
                
                const sign = x < 0 ? -1 : 1;
                x = Math.abs(x);
                
                const t = 1.0 / (1.0 + p * x);
                const y = 1.0 - (((((a5 * t + a4) * t) + a3) * t + a2) * t + a1) * t * Math.exp(-x * x);
                
                return sign * y;
            }

            function chiSquareCDF(x, df) {
                if (x <= 0) return 0;
                if (df === 1) return 2 * normalCDF(Math.sqrt(x)) - 1;
                if (df === 2) return 1 - Math.exp(-x / 2);
                const mean = df;
                const variance = 2 * df;
                const normalized = (x - mean) / Math.sqrt(variance);
                return normalCDF(normalized);
            }

            function displayResults(results, groupNum) {
                const unit = unitSelect.value === 'custom' ? customUnitInput.value : unitSelect.value;
                
                document.getElementById(`lc50-result-${groupNum}`).textContent = 
                    `${results.lc50.toFixed(3)} ${unit}`;
                document.getElementById(`lc50-ci-${groupNum}`).textContent = 
                    `95% CI: ${results.ci50[0].toFixed(3)} - ${results.ci50[1].toFixed(3)} ${unit}`;
                document.getElementById(`lc75-result-${groupNum}`).textContent = 
                    `${results.lc75.toFixed(3)} ${unit}`;
                document.getElementById(`lc90-result-${groupNum}`).textContent = 
                    `${results.lc90.toFixed(3)} ${unit}`;
                document.getElementById(`slope-result-${groupNum}`).textContent = 
                    `${results.slope.toFixed(3)} (R² = ${results.r2.toFixed(3)})`;
            }

            function createChartDatasets(data, results, groupNum) {
                const colors = {
                    1: { point: 'rgba(102, 126, 234, 0.8)', line: '#667eea' },
                    2: { point: 'rgba(17, 153, 142, 0.8)', line: '#11998e' },
                    3: { point: 'rgba(255, 107, 107, 0.8)', line: '#ff6b6b' }
                };
                
                const groupNames = [
                    group1NameInput.value,
                    group2NameInput.value,
                    group3NameInput.value
                ];
                
                return [
                    {
                        label: `實驗數據點 (${groupNames[groupNum-1]})`,
                        data: data.map(d => ({ x: d.concentration, y: d.mortality * 100 })),
                        backgroundColor: colors[groupNum].point,
                        pointRadius: 8,
                        pointHoverRadius: 10,
                        pointBorderWidth: 2,
                        pointBorderColor: 'white'
                    },
                    {
                        label: `Probit 回歸線 (${groupNames[groupNum-1]})`,
                        data: generateLineData(results),
                        type: 'line',
                        borderColor: colors[groupNum].line,
                        borderWidth: 3,
                        fill: false,
                        tension: 0.4,
                        showLine: true,
                        pointRadius: 0,
                        pointHoverRadius: 0
                    }
                ];
            }

            function generateLineData(results) {
                const lineDataPoints = [];
                for (let i = 1; i <= 99; i++) {
                    const p = i / 100;
                    const probitValue = probit(p);
                    const logC = (probitValue - results.intercept) / results.slope;
                    const concentration = Math.pow(10, logC);
                    
                    if (concentration > 0 && concentration < 1e6) {
                        lineDataPoints.push({ x: concentration, y: i });
                    }
                }
                return lineDataPoints;
            }

            function renderChart(datasets) {
                const ctx = document.getElementById('probit-chart').getContext('2d');
                if (probitChart) {
                    probitChart.destroy();
                }

                const unit = unitSelect.value === 'custom' ? customUnitInput.value : unitSelect.value;

                probitChart = new Chart(ctx, {
                    type: 'scatter',
                    data: { datasets: datasets },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Probit 分析圖',
                                font: { size: 16, weight: 'bold' }
                            },
                            legend: {
                                display: true,
                                position: 'top'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        if (context.dataset.label.includes('實驗數據點')) {
                                            return `${context.dataset.label}\n濃度: ${context.raw.x.toFixed(3)} ${unit}\n死亡率: ${context.raw.y.toFixed(1)}%`;
                                        }
                                        return context.dataset.label;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                type: 'logarithmic',
                                title: {
                                    display: true,
                                    text: `濃度 (${unit})`,
                                    font: { size: 14, weight: 'bold' }
                                },
                                ticks: {
                                    callback: function(value) {
                                        return Number(value.toFixed(3));
                                    }
                                },
                                grid: { color: 'rgba(0, 0, 0, 0.1)' }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: '死亡率 (%)',
                                    font: { size: 14, weight: 'bold' }
                                },
                                min: 0,
                                max: 100,
                                ticks: {
                                    stepSize: 10
                                },
                                grid: { color: 'rgba(0, 0, 0, 0.1)' }
                            }
                        },
                        elements: {
                            point: {
                                hoverBackgroundColor: 'rgba(255, 255, 255, 0.8)'
                            }
                        }
                    }
                });
            }

            // 修正後的 PDF 匯出功能
            exportPdfBtn.addEventListener('click', () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                const currentDate = new Date().toLocaleString('zh-TW');

                // 修正：載入字型
                // NotoSansTC_normal 變數由 NotoSansTC-normal.js 腳本檔提供
                doc.addFont('NotoSansTC-normal.ttf', 'NotoSansTC', 'normal');
                doc.setFont('NotoSansTC');
                
                let yPosition = 20;

                // 報告標題與時間
                doc.setFontSize(22);
                doc.setFont('NotoSansTC', 'normal');
                doc.text('LC50/LC75/LC90 分析報告', 105, yPosition, null, null, 'center');
                yPosition += 10;
                doc.setFontSize(10);
                doc.text(`生成時間: ${currentDate}`, 105, yPosition, null, null, 'center');
                yPosition += 20;

                // 匯出各組數據
                const tables = [
                    { id: 'data-table-1', name: group1NameInput ? group1NameInput.value : '實驗組 A', display: true },
                    { id: 'data-table-2', name: group2NameInput ? group2NameInput.value : '實驗組 B', display: dataTable2.querySelector('tbody tr:not(:first-child) input').value !== '' },
                    { id: 'data-table-3', name: group3NameInput ? group3NameInput.value : '實驗組 C', display: dataTable3.querySelector('tbody tr:not(:first-child) input').value !== '' }
                ];

                const addTableToPdf = (table, name) => {
                    const head = [['濃度 (C)', '總數 (N)', '死亡數 (D)', '死亡率 (%)']];
                    const data = Array.from(table.querySelector('tbody').rows).map(row => {
                        const inputs = row.querySelectorAll('input');
                        const mortality = row.querySelector('.mortality-display').textContent;
                        return [
                            inputs[0].value,
                            inputs[1].value,
                            inputs[2].value,
                            mortality
                        ];
                    });
    
                    doc.setFontSize(14);
                    doc.setFont('NotoSansTC', 'normal');
                    doc.text(`${name}實驗數據`, 20, yPosition);
                    yPosition += 8;
                    doc.autoTable({
                        startY: yPosition,
                        head: head,
                        body: data,
                        theme: 'striped',
                        styles: { font: 'NotoSansTC', fontStyle: 'normal' },
                        headStyles: { fillColor: [102, 126, 234], textColor: 255 },
                        margin: { left: 20, right: 20 },
                        didDrawPage: function (data) {
                            yPosition = data.cursor.y + 10;
                        }
                    });
                    yPosition = doc.lastAutoTable.finalY + 10;
                };

                tables.forEach(group => {
                    if (group.display) {
                        addTableToPdf(document.getElementById(group.id), group.name);
                    }
                });

                // 添加計算結果
                doc.setFontSize(14);
                doc.text('計算結果', 20, yPosition);
                yPosition += 8;
                
                if (resultsGroup1.style.display !== 'none') {
                    doc.setFontSize(12);
                    doc.text(`${group1NameInput.value} 結果:`, 25, yPosition);
                    yPosition += 8;
                    doc.setFontSize(11);
                    doc.text(`LC50: ${document.getElementById('lc50-result-1').textContent}`, 30, yPosition);
                    yPosition += 6;
                    doc.text(`${document.getElementById('lc50-ci-1').textContent}`, 30, yPosition);
                    yPosition += 6;
                    doc.text(`LC75: ${document.getElementById('lc75-result-1').textContent}`, 30, yPosition);
                    yPosition += 6;
                    doc.text(`LC90: ${document.getElementById('lc90-result-1').textContent}`, 30, yPosition);
                    yPosition += 6;
                    doc.text(`回歸線斜率: ${document.getElementById('slope-result-1').textContent}`, 30, yPosition);
                    yPosition += 12;
                }
                
                if (resultsGroup2.style.display !== 'none') {
                    if (yPosition + 50 > 280) { doc.addPage(); yPosition = 20; }
                    doc.setFontSize(12);
                    doc.text(`${group2NameInput.value} 結果:`, 25, yPosition);
                    yPosition += 8;
                    doc.setFontSize(11);
                    doc.text(`LC50: ${document.getElementById('lc50-result-2').textContent}`, 30, yPosition);
                    yPosition += 6;
                    doc.text(`${document.getElementById('lc50-ci-2').textContent}`, 30, yPosition);
                    yPosition += 6;
                    doc.text(`LC75: ${document.getElementById('lc75-result-2').textContent}`, 30, yPosition);
                    yPosition += 6;
                    doc.text(`LC90: ${document.getElementById('lc90-result-2').textContent}`, 30, yPosition);
                    yPosition += 6;
                    doc.text(`回歸線斜率: ${document.getElementById('slope-result-2').textContent}`, 30, yPosition);
                    yPosition += 12;
                }
                
                if (resultsGroup3.style.display !== 'none') {
                    if (yPosition + 50 > 280) { doc.addPage(); yPosition = 20; }
                    doc.setFontSize(12);
                    doc.text(`${group3NameInput.value} 結果:`, 25, yPosition);
                    yPosition += 8;
                    doc.setFontSize(11);
                    doc.text(`LC50: ${document.getElementById('lc50-result-3').textContent}`, 30, yPosition);
                    yPosition += 6;
                    doc.text(`${document.getElementById('lc50-ci-3').textContent}`, 30, yPosition);
                    yPosition += 6;
                    doc.text(`LC75: ${document.getElementById('lc75-result-3').textContent}`, 30, yPosition);
                    yPosition += 6;
                    doc.text(`LC90: ${document.getElementById('lc90-result-3').textContent}`, 30, yPosition);
                    yPosition += 6;
                    doc.text(`回歸線斜率: ${document.getElementById('slope-result-3').textContent}`, 30, yPosition);
                    yPosition += 12;
                }
                
                // 添加統計驗證
                if (yPosition + 50 > 280) {
                    doc.addPage();
                    yPosition = 20;
                }
                
                doc.setFontSize(12);
                doc.text('統計驗證', 20, yPosition);
                yPosition += 8;
                doc.setFontSize(10);
                const validationText = validationDetails.innerHTML.replace(/<br>/g, '\n').replace(/<[^>]*>/g, '');
                const splitText = doc.splitTextToSize(validationText, 170);
                doc.text(splitText, 20, yPosition);
                yPosition += splitText.length * 5 + 10;
                
                // 添加圖表
                if (yPosition + 120 > 280) {
                    doc.addPage();
                    yPosition = 20;
                }
                
                doc.setFontSize(12);
                doc.text('Probit 分析圖', 20, yPosition);
                
                html2canvas(document.getElementById('probit-chart')).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    const imgWidth = 170;
                    const imgHeight = canvas.height * imgWidth / canvas.width;
                    
                    if (yPosition + imgHeight > 280) {
                        doc.addPage();
                        yPosition = 20;
                    }
                    
                    doc.addImage(imgData, 'PNG', 20, yPosition + 10, imgWidth, imgHeight);
                    doc.save('LC50_Analysis_Report.pdf');
                });
            });
        });
    </script>
</body>
</html>
