<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>專業 LC50 計算工具 - 改進版</title>
    <style>
        /* CSS 樣式 - 美編與排版 */
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 20px auto;
            background-color: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        h2 {
            text-align: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .subtitle {
            text-align: center;
            color: #666;
            font-size: 1.1em;
            margin-bottom: 30px;
        }

        .input-section, .results-section {
            margin-bottom: 25px;
        }
        
        .data-table-description {
            margin-bottom: 15px;
            color: #555;
            font-style: italic;
            background: #f8f9ff;
            padding: 10px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .unit-selector {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 25px;
            background: #f8f9ff;
            padding: 15px;
            border-radius: 12px;
            border: 2px solid #e1e8ff;
        }

        #unit-select, #custom-unit-input {
            padding: 12px 16px;
            border-radius: 8px;
            border: 2px solid #e1e8ff;
            font-size: 1em;
            transition: all 0.3s ease;
            background: white;
        }
        #unit-select:focus, #custom-unit-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 15px rgba(102, 126, 234, 0.2);
            outline: none;
            transform: translateY(-2px);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        th, td {
            padding: 15px 18px;
            text-align: left;
            border-bottom: 1px solid #f0f2ff;
        }

        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: bold;
            font-size: 1.1em;
        }

        tr:hover {
            background-color: #f8f9ff;
            transform: scale(1.01);
            transition: all 0.2s ease;
        }

        input[type="number"] {
            width: 85%;
            padding: 10px 12px;
            border: 2px solid #e1e8ff;
            border-radius: 6px;
            font-size: 1em;
            transition: all 0.3s ease;
        }

        input[type="number"]:focus {
            border-color: #667eea;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.2);
            outline: none;
        }

        .paste-info {
            font-size: 0.9em;
            color: #888;
            margin-top: 5px;
        }

        .data-group {
            border: 2px solid #e1e8ff;
            padding: 25px;
            margin-bottom: 30px;
            border-radius: 16px;
            background: linear-gradient(135deg, #f8f9ff 0%, #ffffff 100%);
            position: relative;
            overflow: hidden;
        }
        
        .data-group::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .data-group h3 {
            margin-top: 0;
            color: #4a5568;
            font-size: 1.3em;
            margin-bottom: 15px;
        }
        
        .button {
            padding: 14px 28px;
            border: none;
            border-radius: 12px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
        }

        .button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .button:hover::before {
            left: 100%;
        }

        .primary-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        .primary-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
        }

        .accent-button {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: #fff;
            box-shadow: 0 4px 15px rgba(17, 153, 142, 0.4);
        }
        .accent-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(17, 153, 142, 0.6);
        }

        .secondary-button {
            background: linear-gradient(135deg, #606c88 0%, #3f4c6b 100%);
            color: #fff;
            box-shadow: 0 4px 15px rgba(96, 108, 136, 0.4);
        }
        .secondary-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(96, 108, 136, 0.6);
        }

        .actions {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 40px;
            flex-wrap: wrap;
        }
        
        .results-info {
            background: linear-gradient(135deg, #f8f9ff 0%, #ffffff 100%);
            padding: 30px;
            border-radius: 16px;
            text-align: center;
            margin-top: 20px;
            border: 2px solid #e1e8ff;
            position: relative;
            overflow: hidden;
        }
        
        .results-info::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }

        .results-info h3 {
            margin-top: 0;
            color: #2d3748;
            font-size: 1.5em;
        }

        .result-value {
            font-weight: bold;
            color: #e53e3e;
            font-size: 1.3em;
        }

        .confidence-interval {
            font-size: 1em;
            color: #4a5568;
            margin-top: 5px;
        }
        
        .chart-container {
            margin-top: 30px;
            padding: 25px;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9ff 100%);
            border: 2px solid #e1e8ff;
            border-radius: 16px;
            position: relative;
        }
        
        .chart-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .validation-info {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border: 2px solid #f39c12;
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
        }

        .validation-info h4 {
            margin-top: 0;
            color: #d68910;
        }

        .error-message {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            border: 2px solid #dc3545;
            padding: 15px;
            border-radius: 12px;
            margin-top: 15px;
            color: #721c24;
        }

        .success-message {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            border: 2px solid #28a745;
            padding: 15px;
            border-radius: 12px;
            margin-top: 15px;
            color: #155724;
        }

        .data-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid #e1e8ff;
        }

        .stat-card h5 {
            margin: 0 0 10px 0;
            color: #4a5568;
        }

        .stat-value {
            font-size: 1.2em;
            font-weight: bold;
            color: #667eea;
        }
    </style>
</head>
<body>

    <div class="container">
        <h2>LC50、LC75、LC90 計算工具</h2>
        <p class="subtitle">改進版 - 增強統計驗證與精確計算</p>

        <div class="input-section">
            <div class="unit-selector">
                <label for="unit-select">濃度單位:</label>
                <select id="unit-select">
                    <option value="mg/L">mg/L</option>
                    <option value="ppm">ppm</option>
                    <option value="ppb">ppb</option>
                    <option value="ug/L">μg/L</option>
                    <option value="custom">自訂</option>
                </select>
                <input type="text" id="custom-unit-input" placeholder="輸入自訂單位" style="display: none;">
            </div>
            
            <div class="data-group">
                <h3>第一組數據</h3>
                <p class="data-table-description">
                    請輸入您的實驗數據。系統會自動處理極值（0%或100%死亡率）並進行統計驗證。
                    您也可以直接從 Excel 表格複製三欄（濃度、總數、死亡數）到下方表格中。
                </p>
                <table id="data-table-1" class="data-table">
                    <thead>
                        <tr>
                            <th>濃度 (C)</th>
                            <th>總數 (N)</th>
                            <th>死亡數 (D)</th>
                            <th>死亡率 (%)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><input type="number" class="concentration" step="any"></td>
                            <td><input type="number" class="total" min="1"></td>
                            <td><input type="number" class="dead" min="0"></td>
                            <td><span class="mortality-display">--</span></td>
                        </tr>
                    </tbody>
                </table>
                <button id="add-row-btn-1" class="button primary-button">新增數據列</button>
            </div>

            <div class="data-group">
                <h3>第二組數據（可選）</h3>
                <p class="data-table-description">您可以在此處輸入另一組數據，以便與第一組數據進行比較。</p>
                <table id="data-table-2" class="data-table">
                    <thead>
                        <tr>
                            <th>濃度 (C)</th>
                            <th>總數 (N)</th>
                            <th>死亡數 (D)</th>
                            <th>死亡率 (%)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><input type="number" class="concentration" step="any"></td>
                            <td><input type="number" class="total" min="1"></td>
                            <td><input type="number" class="dead" min="0"></td>
                            <td><span class="mortality-display">--</span></td>
                        </tr>
                    </tbody>
                </table>
                <button id="add-row-btn-2" class="button primary-button">新增數據列</button>
            </div>
        </div>

        <hr>

        <div class="actions">
            <button id="calculate-btn" class="button accent-button">計算 LC 值</button>
            <button id="export-pdf-btn" class="button secondary-button" style="display: none;">匯出報告</button>
            <button id="reset-btn" class="button secondary-button">重設</button>
        </div>

        <div class="results-section" id="results-section" style="display: none;">
            <div class="results-info">
                <h3>計算結果</h3>
                <div id="results-group-1">
                    <h4>第一組數據</h4>
                    <div class="data-stats">
                        <div class="stat-card">
                            <h5>LC50</h5>
                            <div class="stat-value" id="lc50-result-1">--</div>
                            <div class="confidence-interval" id="lc50-ci-1">--</div>
                        </div>
                        <div class="stat-card">
                            <h5>LC75</h5>
                            <div class="stat-value" id="lc75-result-1">--</div>
                        </div>
                        <div class="stat-card">
                            <h5>LC90</h5>
                            <div class="stat-value" id="lc90-result-1">--</div>
                        </div>
                        <div class="stat-card">
                            <h5>回歸線斜率 (b)</h5>
                            <div class="stat-value" id="slope-result-1">--</div>
                        </div>
                    </div>
                </div>
                <div id="results-group-2" style="display:none;">
                    <h4>第二組數據</h4>
                    <div class="data-stats">
                        <div class="stat-card">
                            <h5>LC50</h5>
                            <div class="stat-value" id="lc50-result-2">--</div>
                            <div class="confidence-interval" id="lc50-ci-2">--</div>
                        </div>
                        <div class="stat-card">
                            <h5>LC75</h5>
                            <div class="stat-value" id="lc75-result-2">--</div>
                        </div>
                        <div class="stat-card">
                            <h5>LC90</h5>
                            <div class="stat-value" id="lc90-result-2">--</div>
                        </div>
                        <div class="stat-card">
                            <h5>回歸線斜率 (b)</h5>
                            <div class="stat-value" id="slope-result-2">--</div>
                        </div>
                    </div>
                </div>
                
                <div class="validation-info" id="validation-info">
                    <h4>統計驗證</h4>
                    <div id="validation-details">--</div>
                </div>
            </div>
            
            <div class="chart-container">
                <canvas id="probit-chart"></canvas>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const unitSelect = document.getElementById('unit-select');
            const customUnitInput = document.getElementById('custom-unit-input');
            const dataTable1 = document.getElementById('data-table-1');
            const dataTable2 = document.getElementById('data-table-2');
            const addRowBtn1 = document.getElementById('add-row-btn-1');
            const addRowBtn2 = document.getElementById('add-row-btn-2');
            const calculateBtn = document.getElementById('calculate-btn');
            const exportPdfBtn = document.getElementById('export-pdf-btn');
            const resetBtn = document.getElementById('reset-btn');
            const resultsSection = document.getElementById('results-section');
            const resultsGroup1 = document.getElementById('results-group-1');
            const resultsGroup2 = document.getElementById('results-group-2');
            const validationInfo = document.getElementById('validation-info');
            const validationDetails = document.getElementById('validation-details');
            let probitChart;

            // 處理自訂單位輸入框的顯示
            unitSelect.addEventListener('change', () => {
                if (unitSelect.value === 'custom') {
                    customUnitInput.style.display = 'inline-block';
                } else {
                    customUnitInput.style.display = 'none';
                }
            });

            // 新增數據列
            addRowBtn1.addEventListener('click', () => addRow(dataTable1.querySelector('tbody')));
            addRowBtn2.addEventListener('click', () => addRow(dataTable2.querySelector('tbody')));

            function addRow(tableBody) {
                const newRow = tableBody.insertRow();
                newRow.innerHTML = `
                    <td><input type="number" class="concentration" step="any"></td>
                    <td><input type="number" class="total" min="1"></td>
                    <td><input type="number" class="dead" min="0"></td>
                    <td><span class="mortality-display">--</span></td>
                `;
                attachInputListeners(newRow);
            }

            // 附加輸入監聽器來自動計算死亡率
            function attachInputListeners(row) {
                const totalInput = row.querySelector('.total');
                const deadInput = row.querySelector('.dead');
                const mortalityDisplay = row.querySelector('.mortality-display');

                function updateMortality() {
                    const total = parseInt(totalInput.value);
                    const dead = parseInt(deadInput.value);
                    if (!isNaN(total) && !isNaN(dead) && total > 0) {
                        if (dead > total) {
                            deadInput.value = total;
                            dead = total;
                        }
                        const mortality = (dead / total * 100).toFixed(1);
                        mortalityDisplay.textContent = mortality + '%';
                    } else {
                        mortalityDisplay.textContent = '--';
                    }
                }

                totalInput.addEventListener('input', updateMortality);
                deadInput.addEventListener('input', updateMortality);
            }

            // 初始化現有行的監聽器
            document.querySelectorAll('.data-table tbody tr').forEach(attachInputListeners);

            // 處理 Excel 貼上功能
            document.querySelectorAll('.data-table').forEach(table => {
                table.addEventListener('paste', (event) => {
                    const tableBody = table.querySelector('tbody');
                    let pasteData = event.clipboardData.getData('text/plain');
                    let rows = pasteData.trim().split('\n');
                    
                    // 清空現有表格內容
                    tableBody.innerHTML = '';
                    
                    rows.forEach(rowString => {
                        const cols = rowString.trim().split(/[\t\s]+/);
                        if (cols.length >= 3) {
                            const newRow = tableBody.insertRow();
                            const concentration = parseFloat(cols[0]);
                            const total = parseInt(cols[1]);
                            const dead = parseInt(cols[2]);
                            const mortality = (!isNaN(total) && !isNaN(dead) && total > 0) ? 
                                (dead / total * 100).toFixed(1) : '--';
                            
                            newRow.innerHTML = `
                                <td><input type="number" class="concentration" step="any" value="${cols[0]}"></td>
                                <td><input type="number" class="total" min="1" value="${cols[1]}"></td>
                                <td><input type="number" class="dead" min="0" value="${cols[2]}"></td>
                                <td><span class="mortality-display">${mortality}%</span></td>
                            `;
                            attachInputListeners(newRow);
                        }
                    });
                    event.preventDefault();
                });
            });

            // 重設按鈕功能
            resetBtn.addEventListener('click', () => {
                dataTable1.querySelector('tbody').innerHTML = `<tr><td><input type="number" class="concentration" step="any"></td><td><input type="number" class="total" min="1"></td><td><input type="number" class="dead" min="0"></td><td><span class="mortality-display">--</span></td></tr>`;
                dataTable2.querySelector('tbody').innerHTML = `<tr><td><input type="number" class="concentration" step="any"></td><td><input type="number" class="total" min="1"></td><td><input type="number" class="dead" min="0"></td><td><span class="mortality-display">--</span></td></tr>`;
                
                // 重新附加監聽器
                document.querySelectorAll('.data-table tbody tr').forEach(attachInputListeners);
                
                resultsSection.style.display = 'none';
                resultsGroup2.style.display = 'none';
                exportPdfBtn.style.display = 'none';
                if (probitChart) {
                    probitChart.destroy();
                }
            });

            // 主要計算功能
            calculateBtn.addEventListener('click', () => {
                try {
                    const data1 = getDataFromTable(dataTable1);
                    const data2 = getDataFromTable(dataTable2);
                    
                    if (data1.length < 3) {
                        showError('第一組數據請至少輸入三組有效數據以確保統計計算的可靠性。');
                        return;
                    }

                    // 驗證數據質量
                    const validation1 = validateData(data1);
                    if (!validation1.isValid) {
                        showError(`第一組數據驗證失敗：${validation1.message}`);
                        return;
                    }

                    const probitResults1 = calculateProbit(data1);
                    displayResults(probitResults1, 1);
                    
                    let datasets = createChartDatasets(data1, probitResults1, 1);
                    let validationText = `第一組數據：${validation1.message}`;

                    if (data2.length >= 3) {
                        const validation2 = validateData(data2);
                        if (validation2.isValid) {
                            const probitResults2 = calculateProbit(data2);
                            displayResults(probitResults2, 2);
                            datasets = datasets.concat(createChartDatasets(data2, probitResults2, 2));
                            validationText += `<br>第二組數據：${validation2.message}`;
                            resultsGroup2.style.display = 'block';
                        } else {
                            validationText += `<br>第二組數據：驗證失敗 - ${validation2.message}`;
                        }
                    }
                    
                    validationDetails.innerHTML = validationText;
                    resultsSection.style.display = 'block';
                    exportPdfBtn.style.display = 'inline-block';
                    renderChart(datasets);

                } catch (e) {
                    showError('計算失敗：' + e.message);
                }
            });

            function showError(message) {
                // 移除舊的錯誤消息
                const oldError = document.querySelector('.error-message');
                if (oldError) oldError.remove();

                // 創建新的錯誤消息
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-message';
                errorDiv.innerHTML = `<strong>錯誤：</strong> ${message}`;
                calculateBtn.parentNode.insertBefore(errorDiv, calculateBtn.nextSibling);

                // 3秒後自動移除
                setTimeout(() => {
                    errorDiv.remove();
                }, 5000);
            }

            function getDataFromTable(table) {
                const rows = table.querySelectorAll('tbody tr');
                let data = [];
                
                rows.forEach((row, index) => {
                    const concentrationInput = row.querySelector('.concentration');
                    const totalInput = row.querySelector('.total');
                    const deadInput = row.querySelector('.dead');
                    
                    if (!concentrationInput || !totalInput || !deadInput) return;

                    const concentration = parseFloat(concentrationInput.value);
                    const total = parseInt(totalInput.value);
                    const dead = parseInt(deadInput.value);

                    // 驗證並收集數據
                    if (!isNaN(concentration) && !isNaN(total) && !isNaN(dead) && 
                        concentration > 0 && total > 0 && dead >= 0 && dead <= total) {
                        
                        let mortality = dead / total;
                        let adjustedMortality = mortality;
                        
                        // Abbott 校正處理極值
                        if (mortality === 0) {
                            adjustedMortality = 0.5 / total; // 加入小修正值
                        } else if (mortality === 1) {
                            adjustedMortality = (total - 0.5) / total; // 減去小修正值
                        }
                        
                        data.push({
                            concentration: concentration,
                            total: total,
                            dead: dead,
                            mortality: mortality,
                            adjustedMortality: adjustedMortality,
                            probit: probit(adjustedMortality)
                        });
                    }
                });
                
                // 按濃度排序
                data.sort((a, b) => a.concentration - b.concentration);
                return data;
            }

            function validateData(data) {
                if (data.length < 3) {
                    return { isValid: false, message: '數據點不足，需要至少3個有效數據點' };
                }

                // 檢查濃度範圍
                const concentrations = data.map(d => d.concentration);
                const mortalities = data.map(d => d.mortality);
                
                const minConc = Math.min(...concentrations);
                const maxConc = Math.max(...concentrations);
                const minMort = Math.min(...mortalities);
                const maxMort = Math.max(...mortalities);

                if (maxConc / minConc < 2) {
                    return { isValid: false, message: '濃度範圍太小，建議最高濃度至少是最低濃度的2倍' };
                }

                if (maxMort - minMort < 0.3) {
                    return { isValid: false, message: '死亡率變化範圍太小，建議涵蓋至少30%的死亡率變化' };
                }

                // 檢查濃度-反應關係的單調性
                let isMonotonic = true;
                for (let i = 1; i < data.length; i++) {
                    if (data[i
